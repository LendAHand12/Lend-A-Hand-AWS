import{C as M,a as k,P,R as g,r as S,b as J,c as I,d as V,S as m,O as $,e as U,E as z}from"./web3-errors-484f11ce.js";import"./web3-eth-iban-921c5698.js";import{W as H,D as W}from"./web3-types-ce0eb23a.js";import"./is-my-json-valid-2c93b9e3.js";import"./web3-validator-6b520267.js";import{e as K}from"./events-f5832a60.js";import{t as Q,i as f,a as v,b as d,c as X,d as F,e as Y,g as w,h as Z,j as ee,k as te,W as B}from"./web3-utils-f506bce1.js";import{H as ie}from"./web3-providers-http-c372b64e.js";import{W as re}from"./web3-providers-ws-289daea9.js";class R{constructor(){this._emitter=new K.EventEmitter}on(e,t){this._emitter.on(e,t)}once(e,t){this._emitter.once(e,t)}off(e,t){this._emitter.off(e,t)}emit(e,t){this._emitter.emit(e,t)}listenerCount(e){return this._emitter.listenerCount(e)}listeners(e){return this._emitter.listeners(e)}eventNames(){return this._emitter.eventNames()}removeAllListeners(){return this._emitter.removeAllListeners()}setMaxListenerWarningThreshold(e){this._emitter.setMaxListeners(e)}getMaxListeners(){return this._emitter.getMaxListeners()}}var C;(function(s){s.CONFIG_CHANGE="CONFIG_CHANGE"})(C||(C={}));class ne extends R{constructor(e){super(),this.config={handleRevert:!1,defaultAccount:void 0,defaultBlock:"latest",transactionBlockTimeout:50,transactionConfirmationBlocks:24,transactionPollingInterval:1e3,transactionPollingTimeout:750*1e3,transactionReceiptPollingInterval:void 0,transactionSendTimeout:750*1e3,transactionConfirmationPollingInterval:void 0,blockHeaderTimeout:10,maxListenersWarningThreshold:100,defaultNetworkId:void 0,defaultChain:"mainnet",defaultHardfork:"london",defaultCommon:void 0,defaultTransactionType:"0x0",defaultMaxPriorityFeePerGas:Q(25e8),enableExperimentalFeatures:{useSubscriptionWhenCheckingBlockTimeout:!1,useRpcCallSpecification:!1},transactionBuilder:void 0,transactionTypeParser:void 0},this.setConfig(e??{})}setConfig(e){Object.assign(this.config,e)}get handleRevert(){return this.config.handleRevert}set handleRevert(e){this._triggerConfigChange("handleRevert",e),this.config.handleRevert=e}get defaultAccount(){return this.config.defaultAccount}set defaultAccount(e){this._triggerConfigChange("defaultAccount",e),this.config.defaultAccount=e}get defaultBlock(){return this.config.defaultBlock}set defaultBlock(e){this._triggerConfigChange("defaultBlock",e),this.config.defaultBlock=e}get transactionSendTimeout(){return this.config.transactionSendTimeout}set transactionSendTimeout(e){this._triggerConfigChange("transactionSendTimeout",e),this.config.transactionSendTimeout=e}get transactionBlockTimeout(){return this.config.transactionBlockTimeout}set transactionBlockTimeout(e){this._triggerConfigChange("transactionBlockTimeout",e),this.config.transactionBlockTimeout=e}get transactionConfirmationBlocks(){return this.config.transactionConfirmationBlocks}set transactionConfirmationBlocks(e){this._triggerConfigChange("transactionConfirmationBlocks",e),this.config.transactionConfirmationBlocks=e}get transactionPollingInterval(){return this.config.transactionPollingInterval}set transactionPollingInterval(e){this._triggerConfigChange("transactionPollingInterval",e),this.config.transactionPollingInterval=e,this.transactionReceiptPollingInterval=e,this.transactionConfirmationPollingInterval=e}get transactionPollingTimeout(){return this.config.transactionPollingTimeout}set transactionPollingTimeout(e){this._triggerConfigChange("transactionPollingTimeout",e),this.config.transactionPollingTimeout=e}get transactionReceiptPollingInterval(){return this.config.transactionReceiptPollingInterval}set transactionReceiptPollingInterval(e){this._triggerConfigChange("transactionReceiptPollingInterval",e),this.config.transactionReceiptPollingInterval=e}get transactionConfirmationPollingInterval(){return this.config.transactionConfirmationPollingInterval}set transactionConfirmationPollingInterval(e){this._triggerConfigChange("transactionConfirmationPollingInterval",e),this.config.transactionConfirmationPollingInterval=e}get blockHeaderTimeout(){return this.config.blockHeaderTimeout}set blockHeaderTimeout(e){this._triggerConfigChange("blockHeaderTimeout",e),this.config.blockHeaderTimeout=e}get enableExperimentalFeatures(){return this.config.enableExperimentalFeatures}set enableExperimentalFeatures(e){this._triggerConfigChange("enableExperimentalFeatures",e),this.config.enableExperimentalFeatures=e}get maxListenersWarningThreshold(){return this.config.maxListenersWarningThreshold}set maxListenersWarningThreshold(e){this._triggerConfigChange("maxListenersWarningThreshold",e),this.setMaxListenerWarningThreshold(e),this.config.maxListenersWarningThreshold=e}get defaultNetworkId(){return this.config.defaultNetworkId}set defaultNetworkId(e){this._triggerConfigChange("defaultNetworkId",e),this.config.defaultNetworkId=e}get defaultChain(){return this.config.defaultChain}set defaultChain(e){if(!f(this.config.defaultCommon)&&!f(this.config.defaultCommon.baseChain)&&e!==this.config.defaultCommon.baseChain)throw new M(this.config.defaultChain,e);this._triggerConfigChange("defaultChain",e),this.config.defaultChain=e}get defaultHardfork(){return this.config.defaultHardfork}set defaultHardfork(e){if(!f(this.config.defaultCommon)&&!f(this.config.defaultCommon.hardfork)&&e!==this.config.defaultCommon.hardfork)throw new k(this.config.defaultCommon.hardfork,e);this._triggerConfigChange("defaultHardfork",e),this.config.defaultHardfork=e}get defaultCommon(){return this.config.defaultCommon}set defaultCommon(e){if(!f(this.config.defaultHardfork)&&!f(e)&&!f(e.hardfork)&&this.config.defaultHardfork!==e.hardfork)throw new k(this.config.defaultHardfork,e.hardfork);if(!f(this.config.defaultChain)&&!f(e)&&!f(e.baseChain)&&this.config.defaultChain!==e.baseChain)throw new M(this.config.defaultChain,e.baseChain);this._triggerConfigChange("defaultCommon",e),this.config.defaultCommon=e}get defaultTransactionType(){return this.config.defaultTransactionType}set defaultTransactionType(e){this._triggerConfigChange("defaultTransactionType",e),this.config.defaultTransactionType=e}get defaultMaxPriorityFeePerGas(){return this.config.defaultMaxPriorityFeePerGas}set defaultMaxPriorityFeePerGas(e){this._triggerConfigChange("defaultMaxPriorityFeePerGas",e),this.config.defaultMaxPriorityFeePerGas=e}get transactionBuilder(){return this.config.transactionBuilder}set transactionBuilder(e){this._triggerConfigChange("transactionBuilder",e),this.config.transactionBuilder=e}get transactionTypeParser(){return this.config.transactionTypeParser}set transactionTypeParser(e){this._triggerConfigChange("transactionTypeParser",e),this.config.transactionTypeParser=e}_triggerConfigChange(e,t){this.emit(C.CONFIG_CHANGE,{name:e,oldValue:this.config[e],newValue:t})}}const O=s=>H.isWeb3Provider(s),G=s=>typeof s!="string"&&"request"in s&&s.request.constructor.name==="Function",se=s=>typeof s!="string"&&"request"in s&&s.request.constructor.name==="AsyncFunction",L=s=>typeof s!="string"&&"send"in s,j=s=>typeof s!="string"&&"sendAsync"in s,oe=s=>H.isWeb3Provider(s)||G(s)||j(s)||L(s),ae=s=>O(s)?s.supportsSubscriptions():typeof s!="string"&&"on"in s;var y=globalThis&&globalThis.__awaiter||function(s,e,t,i){function r(n){return n instanceof t?n:new t(function(a){a(n)})}return new(t||(t=Promise))(function(n,a){function u(o){try{c(i.next(o))}catch(l){a(l)}}function h(o){try{c(i.throw(o))}catch(l){a(l)}}function c(o){o.done?n(o.value):r(o.value).then(u,h)}c((i=i.apply(s,e||[])).next())})},_;(function(s){s.PROVIDER_CHANGED="PROVIDER_CHANGED",s.BEFORE_PROVIDER_CHANGE="BEFORE_PROVIDER_CHANGE"})(_||(_={}));const x={HttpProvider:ie,WebsocketProvider:re};class p extends R{constructor(e,t){super(),f(e)||this.setProvider(e),this.useRpcCallSpecification=t}static get providers(){return x}get provider(){return this._provider}get providers(){return x}setProvider(e){let t;if(e&&typeof e=="string"&&this.providers)if(/^http(s)?:\/\//i.test(e))t=new this.providers.HttpProvider(e);else if(/^ws(s)?:\/\//i.test(e))t=new this.providers.WebsocketProvider(e);else throw new P(`Can't autodetect provider for "${e}"`);else f(e)?t=void 0:t=e;return this.emit(_.BEFORE_PROVIDER_CHANGE,this._provider),this._provider=t,this.emit(_.PROVIDER_CHANGED,this._provider),!0}send(e){return y(this,void 0,void 0,function*(){const t=yield this._sendRequest(e);if(v(t))return t.result;throw new g(t)})}sendBatch(e){return y(this,void 0,void 0,function*(){return yield this._sendRequest(e)})}_sendRequest(e){return y(this,void 0,void 0,function*(){const{provider:t}=this;if(f(t))throw new P("Provider not available. Use `.setProvider` or `.provider=` to initialize the provider.");const i=d(e)?X(e):F(e);if(O(t)){let r;try{r=yield t.request(i)}catch(n){r=n}return this._processJsonRpcResponse(i,r,{legacy:!1,error:!1})}if(se(t))return t.request(i).then(r=>this._processJsonRpcResponse(i,r,{legacy:!0,error:!1})).catch(r=>this._processJsonRpcResponse(i,r,{legacy:!0,error:!0}));if(G(t))return new Promise((r,n)=>{const a=c=>n(this._processJsonRpcResponse(i,c,{legacy:!0,error:!0})),u=c=>r(this._processJsonRpcResponse(i,c,{legacy:!0,error:!1})),h=t.request(i,(c,o)=>c?a(c):u(o));Y(h)&&h.then(u).catch(a)});if(L(t))return new Promise((r,n)=>{t.send(i,(a,u)=>{if(a)return n(this._processJsonRpcResponse(i,a,{legacy:!0,error:!0}));if(f(u))throw new g("",'Got a "nullish" response from provider.');return r(this._processJsonRpcResponse(i,u,{legacy:!0,error:!1}))})});if(j(t))return t.sendAsync(i).then(r=>this._processJsonRpcResponse(i,r,{legacy:!0,error:!1})).catch(r=>this._processJsonRpcResponse(i,r,{legacy:!0,error:!0}));throw new P("Provider does not have a request or send method to use.")})}_processJsonRpcResponse(e,t,{legacy:i,error:r}){if(f(t))return this._buildResponse(e,null,r);if(w(t)){if(this.useRpcCallSpecification&&Z(t)){const n=t;if(S.get(n.error.code)){const a=S.get(n.error.code).error;throw new a(n)}else throw new J(n)}else if(!p._isReverted(t))throw new I(t,e)}if(v(t))return t;if(t instanceof Error)throw p._isReverted(t),t;if(!i&&d(e)&&ee(t)||i&&!r&&d(e))return t;if(i&&r&&d(e))throw t;if(i&&!w(t)&&!v(t))return this._buildResponse(e,t,r);throw d(e)&&!Array.isArray(t)?new g(t,"Got normal response for a batch request."):!d(e)&&Array.isArray(t)?new g(t,"Got batch response for a normal request."):(w(t)||v(t))&&!d(e)&&t.id&&e.id!==t.id?new I(t):new g(t,"Invalid response")}static _isReverted(e){let t;if(w(e)?t=e.error:e instanceof Error&&(t=e),t!=null&&t.message.includes("revert"))throw new V(t);return!1}_buildResponse(e,t,i){const r={jsonrpc:"2.0",id:d(e)?e[0].id:"id"in e?e.id:null};return i?Object.assign(Object.assign({},r),{error:t}):Object.assign(Object.assign({},r),{result:t})}}var b=globalThis&&globalThis.__awaiter||function(s,e,t,i){function r(n){return n instanceof t?n:new t(function(a){a(n)})}return new(t||(t=Promise))(function(n,a){function u(o){try{c(i.next(o))}catch(l){a(l)}}function h(o){try{c(i.throw(o))}catch(l){a(l)}}function c(o){o.done?n(o.value):r(o.value).then(u,h)}c((i=i.apply(s,e||[])).next())})};class A{constructor(e,t){this.requestManager=e,this.registeredSubscriptions=t,this._subscriptions=new Map,this.requestManager.on(_.BEFORE_PROVIDER_CHANGE,()=>b(this,void 0,void 0,function*(){yield this.unsubscribe()})),this.requestManager.on(_.PROVIDER_CHANGED,()=>{this.clear()})}subscribe(e,t,i=W){return b(this,void 0,void 0,function*(){if(!this.requestManager.provider)throw new P("Provider not available");const r=this.registeredSubscriptions[e];if(!r)throw new m("Invalid subscription type");const n=new r(t??void 0,{requestManager:this.requestManager,returnFormat:i});return yield this.addSubscription(n),n})}get subscriptions(){return this._subscriptions}addSubscription(e){return b(this,void 0,void 0,function*(){if(!this.supportsSubscriptions())throw new m("The current provider does not support subscriptions");if(e.id&&this._subscriptions.has(e.id))throw new m(`Subscription with id "${e.id}" already exists`);if(yield e.subscribe(),f(e.id))throw new m("Subscription is not subscribed yet.");this._subscriptions.set(e.id,e)})}removeSubscription(e){return b(this,void 0,void 0,function*(){if(f(e.id))throw new m("Subscription is not subscribed yet. Or, had already been unsubscribed but not through the Subscription Manager.");if(!this._subscriptions.has(e.id))throw new m(`Subscription with id "${e.id.toString()}" does not exists`);const{id:t}=e;return yield e.unsubscribe(),this._subscriptions.delete(t),t})}unsubscribe(e){return b(this,void 0,void 0,function*(){const t=[];for(const[i,r]of this.subscriptions.entries())(!e||typeof e=="function"&&e({id:i,sub:r}))&&t.push(this.removeSubscription(r));return Promise.all(t)})}clear(){this._subscriptions.clear()}supportsSubscriptions(){return f(this.requestManager.provider)?!1:ae(this.requestManager.provider)}}var q=globalThis&&globalThis.__awaiter||function(s,e,t,i){function r(n){return n instanceof t?n:new t(function(a){a(n)})}return new(t||(t=Promise))(function(n,a){function u(o){try{c(i.next(o))}catch(l){a(l)}}function h(o){try{c(i.throw(o))}catch(l){a(l)}}function c(o){o.done?n(o.value):r(o.value).then(u,h)}c((i=i.apply(s,e||[])).next())})};class ve extends R{constructor(e,t){var i;super(),this.args=e,this._requestManager=t.requestManager,this._returnFormat=(i=t.returnFormat)!==null&&i!==void 0?i:W}get id(){return this._id}get lastBlock(){return this._lastBlock}subscribe(){return q(this,void 0,void 0,function*(){this._id=yield this._requestManager.send({method:"eth_subscribe",params:this._buildSubscriptionParams()});const e=t=>{var i,r;if(t!=null&&t.data){this._processSubscriptionResult((r=(i=t==null?void 0:t.data)===null||i===void 0?void 0:i.result)!==null&&r!==void 0?r:t==null?void 0:t.data);return}t&&te(t)&&this._processSubscriptionResult(t==null?void 0:t.params.result)};typeof this._requestManager.provider.request=="function"?this._requestManager.provider.on("message",e):this._requestManager.provider.on("data",e),this._messageListener=e})}get returnFormat(){return this._returnFormat}resubscribe(){return q(this,void 0,void 0,function*(){yield this.unsubscribe(),yield this.subscribe()})}unsubscribe(){return q(this,void 0,void 0,function*(){this.id&&(yield this._requestManager.send({method:"eth_unsubscribe",params:[this.id]}),this._id=void 0,this._requestManager.provider.removeListener("message",this._messageListener))})}_processSubscriptionResult(e){}_processSubscriptionError(e){}_buildSubscriptionParams(){throw new Error("Implement in the child class")}}var N=globalThis&&globalThis.__awaiter||function(s,e,t,i){function r(n){return n instanceof t?n:new t(function(a){a(n)})}return new(t||(t=Promise))(function(n,a){function u(o){try{c(i.next(o))}catch(l){a(l)}}function h(o){try{c(i.throw(o))}catch(l){a(l)}}function c(o){o.done?n(o.value):r(o.value).then(u,h)}c((i=i.apply(s,e||[])).next())})};const ue=1e3;class ce{constructor(e){this._requestManager=e,this._requests=new Map}get requests(){return[...this._requests.values()].map(e=>e.payload)}add(e){const t=F(e),i=new B;return this._requests.set(t.id,{payload:t,promise:i}),i}execute(){return N(this,void 0,void 0,function*(){if(this.requests.length===0)return Promise.resolve([]);const e=new B({timeout:ue,eagerStart:!0,timeoutMessage:"Batch request timeout"});return this._processBatchRequest(e).catch(t=>e.reject(t)),e.catch(t=>{t instanceof $&&this._abortAllRequests("Batch request timeout"),e.reject(t)}),e})}_processBatchRequest(e){var t,i;return N(this,void 0,void 0,function*(){const r=yield this._requestManager.sendBatch([...this._requests.values()].map(u=>u.payload));if(r.length!==this._requests.size)throw this._abortAllRequests("Invalid batch response"),new g(r,`Batch request size mismatch the results size. Requests: ${this._requests.size}, Responses: ${r.length}`);const n=this.requests.map(u=>u.id).map(Number).sort((u,h)=>u-h),a=r.map(u=>u.id).map(Number).sort((u,h)=>u-h);if(JSON.stringify(n)!==JSON.stringify(a))throw this._abortAllRequests("Invalid batch response"),new g(r,`Batch request mismatch the results. Requests: [${n.join()}], Responses: [${a.join()}]`);for(const u of r)v(u)?(t=this._requests.get(u.id))===null||t===void 0||t.promise.resolve(u.result):w(u)&&((i=this._requests.get(u.id))===null||i===void 0||i.promise.reject(u.error));e.resolve(r)})}_abortAllRequests(e){for(const{promise:t}of this._requests.values())t.reject(new U(e))}}class T extends ne{constructor(e){var t;if(super(),this.providers=p.providers,f(e)||typeof e=="string"&&e.trim()!==""||oe(e)){this._requestManager=new p(e),this._subscriptionManager=new A(this._requestManager,{});return}const{config:i,provider:r,requestManager:n,subscriptionManager:a,registeredSubscriptions:u,accountProvider:h,wallet:c}=e;this.setConfig(i??{}),this._requestManager=n??new p(r,(t=i==null?void 0:i.enableExperimentalFeatures)===null||t===void 0?void 0:t.useSubscriptionWhenCheckingBlockTimeout),a?this._subscriptionManager=a:u&&(this._subscriptionManager=new A(this.requestManager,u)),h&&(this._accountProvider=h),c&&(this._wallet=c)}get requestManager(){return this._requestManager}get subscriptionManager(){return this._subscriptionManager}get wallet(){return this._wallet}get accountProvider(){return this._accountProvider}static fromContextObject(...e){return new this(...e.reverse())}getContextObject(){var e;return{config:this.config,provider:this.provider,requestManager:this.requestManager,subscriptionManager:this.subscriptionManager,registeredSubscriptions:(e=this.subscriptionManager)===null||e===void 0?void 0:e.registeredSubscriptions,providers:this.providers,wallet:this.wallet,accountProvider:this.accountProvider}}use(e,...t){const i=new e(...t,this.getContextObject());return this.on(C.CONFIG_CHANGE,r=>{i.setConfig({[r.name]:r.newValue})}),i}link(e){this.setConfig(e.config),this._requestManager=e.requestManager,this.provider=e.provider,this._subscriptionManager=e.subscriptionManager,this._wallet=e.wallet,this._accountProvider=e._accountProvider,e.on(C.CONFIG_CHANGE,t=>{this.setConfig({[t.name]:t.newValue})})}registerPlugin(e){if(this[e.pluginNamespace]!==void 0)throw new z(e.pluginNamespace);const t={[e.pluginNamespace]:e};t[e.pluginNamespace].link(this),Object.assign(this,t)}get provider(){return this.currentProvider}set provider(e){this.requestManager.setProvider(e)}get currentProvider(){return this.requestManager.provider}set currentProvider(e){this.requestManager.setProvider(e)}get givenProvider(){return T.givenProvider}setProvider(e){return this.provider=e,!0}get BatchRequest(){return ce.bind(void 0,this._requestManager)}}T.providers=p.providers;var E=globalThis&&globalThis.__awaiter||function(s,e,t,i){function r(n){return n instanceof t?n:new t(function(a){a(n)})}return new(t||(t=Promise))(function(n,a){function u(o){try{c(i.next(o))}catch(l){a(l)}}function h(o){try{c(i.throw(o))}catch(l){a(l)}}function c(o){o.done?n(o.value):r(o.value).then(u,h)}c((i=i.apply(s,e||[])).next())})},D;class we extends R{constructor(e){super(),this[D]="Promise",this._promise=new Promise(e)}then(e,t){return E(this,void 0,void 0,function*(){return this._promise.then(e,t)})}catch(e){return E(this,void 0,void 0,function*(){return this._promise.catch(e)})}finally(e){return E(this,void 0,void 0,function*(){return this._promise.finally(e)})}on(e,t){return super.on(e,t),this}once(e,t){return super.once(e,t),this}}D=Symbol.toStringTag;export{T as W,we as a,ve as b,C as c,oe as i};
